<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Tickets</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>Movie Ticketing</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="booking.html" aria-current="page">Book Tickets</a></li>
                    <li><a href="login.html">Login</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main>
        <section class="booking">
            <div class="container">
                <h2>Choose a movie to start your booking</h2>
                <p class="intro">Tap a movie card below to see the available seats and confirm your tickets.</p>
                <div class="movie-options">
                    <button type="button" class="movie-option" data-movie="Midnight City" data-time="Today Â· 7:30 PM">
                        <img src="assets/movie1.jpg" alt="Midnight City poster">
                        <span>Midnight City</span>
                    </button>
                    <button type="button" class="movie-option" data-movie="Ocean Quest" data-time="Today Â· 9:00 PM">
                        <img src="assets/movie2.jpg" alt="Ocean Quest poster">
                        <span>Ocean Quest</span>
                    </button>
                    <button type="button" class="movie-option" data-movie="Sky High" data-time="Tomorrow Â· 6:15 PM">
                        <img src="assets/movie3.jpg" alt="Sky High poster">
                        <span>Sky High</span>
                    </button>
                </div>
                <form id="booking-form" hidden>
                    <h3 id="selected-movie"></h3>
                    <p id="selected-time" class="selected-time"></p>
                    <label for="seats">Number of seats</label>
                    <input type="number" id="seats" name="seats" min="1" max="10" value="1" required>
                    <button type="submit" class="btn">Book now</button>
                </form>
            </div>
        </section>
    </main>
    <script>
        const movieOptions = document.querySelectorAll('.movie-option');
        const bookingForm = document.getElementById('booking-form');
        const selectedMovie = document.getElementById('selected-movie');
        const selectedTime = document.getElementById('selected-time');

        movieOptions.forEach(option => {
            option.addEventListener('click', () => {
                movieOptions.forEach(button => button.classList.remove('active'));
                option.classList.add('active');

                selectedMovie.textContent = `Booking for: ${option.dataset.movie}`;
                selectedTime.textContent = option.dataset.time;
                bookingForm.hidden = false;
            });
        });

        bookingForm.addEventListener('submit', async event => {
  event.preventDefault();

  const seats = document.getElementById('seats').value;
  const movieTitle = selectedMovie.textContent.replace('Booking for: ', '');

  // ðŸ” Pemetaan judul dari tampilan ke database
  const movieMap = {
    "Midnight City": "Flow",
    "Ocean Quest": "Civil War",
    "Sky High": "Crow"
  };

  const mappedTitle = movieMap[movieTitle] || movieTitle;

  // Ambil data film dari API
  const resMovies = await fetch('/api/movies');
  const movies = await resMovies.json();
  const movie = movies.find(m => m.title === mappedTitle);

  if (!movie) {
    alert(`Film "${movieTitle}" tidak ditemukan di database.`);
    return;
  }

  // Misal user_id sementara = 1
  const payload = { user_id: 1, movie_id: movie.id, seats: Number(seats) };
  console.log('Submitting booking:', payload);

  const res = await fetch('/api/bookings', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  console.log('Server response:', json);

  if (json.ok) alert(`Booking untuk "${movieTitle}" berhasil!`);
  else alert('Booking gagal: ' + (json.message || 'Unknown error'));
});


    </script>
</body>
</html>